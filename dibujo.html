<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Imagem & A√ß√£o ‚Äî V11</title>
<style>
  :root{
    --gap:12px; --radius:18px;
    --ink:#000; --bg:#fffbef;
    --accent:#ffd400;        /* amarelo chapado */
    --accent2:#43d3ff;       /* ciano chapado */
    --hotpink:#ff2ebd;       /* rosa forte (nomes no chat) */
    --card:#ffffff;
    --dark:#000000;
  }
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:var(--bg);color:#111}
  header{position:sticky;top:0;background:var(--card);padding:12px 16px;z-index:10;border-bottom:4px solid var(--ink)}
  header h1{font-size:18px;margin:0 0 4px}
  header .row{display:grid;grid-template-columns:1fr auto;gap:var(--gap);align-items:center}
  .pill{font-size:12px;background:var(--dark);color:#fff;padding:4px 10px;border-radius:999px;border:3px solid var(--ink)}
  main{max-width:1100px;margin:20px auto;padding:0 16px;display:grid;gap:var(--gap)}
  .grid{display:grid;grid-template-columns:280px 1fr 320px;gap:var(--gap);align-items:start}
  .card{background:var(--card);border:4px solid var(--ink);border-radius:22px;padding:12px}
  label{display:grid;gap:6px;font-size:14px}

  /* Bot√µes menores + chapados + borda preta grossa */
  button,input,select{font:inherit}
  button{cursor:pointer;border:4px solid var(--ink);border-radius:12px;padding:6px 10px;font-weight:700}
  button:disabled{opacity:.5;cursor:not-allowed}
  .btn-yellow{background:var(--accent)}
  .btn-cyan{background:var(--accent2)}
  .btn-dark{background:#222;color:#fff}

  .controls{display:grid;gap:var(--gap)}
  .row2{display:grid;grid-template-columns:1fr 1fr;gap:var(--gap)}

  /* Lousa */
  #canvasWrap{position:relative;background:#fff;border:6px solid var(--ink);border-radius:26px;overflow:hidden}
  canvas{display:block;width:100%;height:540px;background:#fff;touch-action:none}
  /* Timer grande no topo da lousa */
  #timerHUD{
    position:absolute;left:50%;top:8px;transform:translateX(-50%);
    background:var(--accent);border:4px solid var(--ink);border-radius:999px;
    padding:6px 14px;font-weight:900;font-size:28px;letter-spacing:1px;
  }
  /* Overlay de fim/acerto */
  #overlay{
    position:absolute;inset:0;display:none;align-items:center;justify-content:center;
    background:rgba(255,255,255,.85); /* leve v√©u */
  }
  #overlay .msg{
    text-align:center;font-weight:900;line-height:1.1;
    color:#111;background:#fff;border:6px solid var(--ink);border-radius:24px;
    padding:22px 26px;max-width:90%;
    font-size:36px; text-transform:uppercase;
  }

  .info{font-size:12px;color:#333}
  #players{font-size:14px;display:grid;gap:6px}

  /* Chat estilo ‚Äúcartoon‚Äù: fundo preto, texto branco, nomes rosa ao lado */
  #chat{height:340px;overflow:auto;background:#000;color:#fff;
        border:6px solid var(--ink);border-radius:18px;padding:10px}
  .chat-row{display:flex;align-items:flex-start;gap:10px;margin-bottom:10px}
  .chat-name{color:var(--hotpink);font-weight:900;min-width:90px;text-align:right}
  .chat-text{
    background:#111;color:#fff;border:4px solid var(--ink);border-radius:12px;
    padding:6px 10px;max-width:100%;word-wrap:break-word
  }
  .chat-correct{background:#12c94c !important;color:#000}

  .word{font-weight:800;letter-spacing:.5px}
  .hint{font-family:ui-monospace,Menlo,Consolas,monospace;letter-spacing:2px}
  .sep{height:1px;background:#000;margin:8px 0;opacity:.15}
  .timer{font-weight:800}
  input[type="text"], input[type="color"], input[type="range"]{border:4px solid var(--ink);border-radius:10px;padding:6px}

  @media (max-width:1024px){.grid{grid-template-columns:1fr} canvas{height:420px}}
</style>
</head>
<body>
<header>
  <div class="row">
    <div>
      <h1>Imagem & A√ß√£o ‚Äî V11</h1>
      <div class="info">Bordas pretas grossas, cores chapadas, timer na lousa, overlay de fim, chat estilizado.</div>
    </div>
    <div class="pill" id="status">desconectado</div>
  </div>
</header>

<main>
  <div class="grid">
    <!-- CONTROLES -->
    <section class="card controls">
      <div class="row2">
        <label><div>Apelido</div><input id="nick" placeholder="ex.: Alex"></label>
        <label><div>Sala</div><input id="room" placeholder="ex.: geral"></label>
      </div>
      <div class="row2">
        <button id="connect" class="btn-cyan">Conectar</button>
        <button id="leave" class="btn-dark" disabled>Sair</button>
      </div>
      <div class="sep"></div>
      <div class="row2">
        <button id="startGame" class="btn-yellow" disabled>Iniciar jogo</button>
        <button id="endRound" class="btn-dark" disabled>Terminar rodada</button>
      </div>
      <div class="row2">
        <button id="clear" class="btn-yellow" disabled>Limpar desenho</button>
      </div>
      <div class="sep"></div>
      <div>
        <div class="info"><strong>Palavra (s√≥ desenhista):</strong> <span id="word" class="word">‚Äî</span></div>
        <div class="info"><strong>Dica p/ todos:</strong> <span id="hint" class="hint">‚Äî</span></div>
        <div class="info"><strong>Desenhista atual:</strong> <span id="drawerName">‚Äî</span></div>
        <div class="info"><strong>Status:</strong> <span id="roundStatus">‚Äî</span></div>
        <div class="info"><strong>Tempo restante:</strong> <span id="timer" class="timer">‚Äî</span></div>
      </div>
      <div class="sep"></div>
      <div><div class="info"><strong>Espessura:</strong></div><input id="size" type="range" min="2" max="18" value="6"></div>
      <div><div class="info"><strong>Cor:</strong></div><input id="color" type="color" value="#111111"></div>
    </section>

    <!-- LOUSA -->
    <section class="card" id="canvasWrap">
      <div id="timerHUD">--:--</div>
      <div id="overlay"><div class="msg"></div></div>
      <canvas id="c"></canvas>
    </section>

    <!-- CHAT -->
    <section class="card">
      <div style="display:grid;gap:10px;">
        <div><strong>Jogadores</strong></div>
        <div id="players"></div>
        <div class="sep"></div>
        <div><strong>Chat / Palpites</strong></div>
        <div id="chat" aria-live="polite" aria-busy="true"></div>
        <form id="chatForm" style="display:grid;grid-template-columns:1fr auto;gap:10px;margin-top:6px;">
          <input id="chatInput" placeholder="Digite seu palpite‚Ä¶" autocomplete="off" style="border:4px solid var(--ink);border-radius:12px;padding:8px">
          <button id="send" type="submit" class="btn-cyan" disabled>Enviar</button>
        </form>
      </div>
    </section>
  </div>
</main>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script>
/* ---------- Firebase ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyA9FBaZDDJ_fOOWW4JNxoR_IbHCTG9CgqE",
  authDomain: "chatenvivo-6b518.firebaseapp.com",
  projectId: "chatenvivo-6b518",
  storageBucket: "chatenvivo-6b518.firebasestorage.app",
  messagingSenderId: "351680385901",
  appId: "1:351680385901:web:8105134053b010cd69c064",
  measurementId: "G-HF86GVYTVC"
};
let app, db;
try { app=firebase.initializeApp(firebaseConfig); db=firebase.firestore(); document.getElementById("status").textContent="SDK carregado"; }
catch(e){ document.getElementById("status").textContent="erro na config"; console.error(e); }

/* ---------- Elements & State ---------- */
const $status=document.getElementById("status");
const $nick=document.getElementById("nick");
const $room=document.getElementById("room");
const $connect=document.getElementById("connect");
const $leave=document.getElementById("leave");
const $startGame=document.getElementById("startGame");
const $endRound=document.getElementById("endRound");
const $clear=document.getElementById("clear");
const $word=document.getElementById("word");
const $hint=document.getElementById("hint");
const $drawerName=document.getElementById("drawerName");
const $roundStatus=document.getElementById("roundStatus");
const $timer=document.getElementById("timer");
const $players=document.getElementById("players");
const $timerHUD=document.getElementById("timerHUD");
const $overlay=document.getElementById("overlay");
const $overlayMsg=$overlay.querySelector(".msg");

const $c=document.getElementById("c");
const ctx=$c.getContext("2d");
const $size=document.getElementById("size");
const $color=document.getElementById("color");

const $chat=document.getElementById("chat");
const $chatForm=document.getElementById("chatForm");
const $chatInput=document.getElementById("chatInput");
const $send=document.getElementById("send");

let roomId="", nick="", isDrawer=false;
let unsubRoom=null, unsubState=null, unsubGuesses=null, unsubPlayers=null;
let heartbeatInt=null, countdownInt=null;
let gameStatus="‚Äî", playersList=[];
let currentRound=0, lastClearedAt=0;
let lastWinner=null, lastWord=null;

/* ---------- Util ---------- */
const WORDS=["casa","gato","√°rvore","carro","lua","peixe","pizza","livro","bicicleta","montanha"];
const pickWord = ()=> WORDS[Math.floor(Math.random()*WORDS.length)];
const makeHint = w => w.replace(/[a-z√°√©√≠√≥√∫√£√µ√¢√™√Æ√¥√ª√ß]/gi," _ ");
const normalize=s=>(s||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9 ]/g,"").trim();
function showOverlay(msg){ $overlayMsg.textContent=msg; $overlay.style.display="flex"; }
function hideOverlay(){ $overlay.style.display="none"; $overlayMsg.textContent=""; }

/* ---------- Canvas size (Hi-DPI) ---------- */
let dpr=Math.max(1,window.devicePixelRatio||1);
function resizeCanvas(){
  const r=$c.getBoundingClientRect();
  $c.width=Math.floor(r.width*dpr); $c.height=Math.floor(r.height*dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
window.addEventListener("resize",()=>{ dpr=Math.max(1,window.devicePixelRatio||1); resizeCanvas(); });
setTimeout(resizeCanvas,0);

/* ---------- Connect ---------- */
$connect.addEventListener("click", async ()=>{
  nick=($nick.value||"Anon").trim();
  roomId=($room.value||"geral").trim().toLowerCase();
  if(!db) return alert("Firebase n√£o configurado.");
  if(!nick) return alert("Escolha um apelido.");

  $connect.disabled=true; $leave.disabled=false; $send.disabled=false; $startGame.disabled=false;
  $status.textContent="conectado";

  const playerRef=db.collection("salas").doc(roomId).collection("players").doc(nick);
  await playerRef.set({nick,online:true,joinedAt:firebase.firestore.FieldValue.serverTimestamp(),lastSeen:firebase.firestore.FieldValue.serverTimestamp()},{merge:true});
  heartbeatInt=setInterval(()=>playerRef.set({online:true,lastSeen:firebase.firestore.FieldValue.serverTimestamp()},{merge:true}),5000);
  window.addEventListener("beforeunload",()=>{try{playerRef.set({online:false,lastSeen:firebase.firestore.FieldValue.serverTimestamp()},{merge:true})}catch{};});

  listenRoom(); listenPlayers(); listenState();
});

/* ---------- Leave ---------- */
$leave.addEventListener("click",()=>{
  [unsubRoom,unsubState,unsubGuesses,unsubPlayers].forEach(fn=>fn&&fn());
  if(heartbeatInt){clearInterval(heartbeatInt);heartbeatInt=null}
  if(countdownInt){clearInterval(countdownInt);countdownInt=null}
  $connect.disabled=false; $leave.disabled=true; $send.disabled=true; $startGame.disabled=true; $endRound.disabled=true; $clear.disabled=true;
  $status.textContent="desconectado"; isDrawer=false; gameStatus="‚Äî"; currentRound=0; lastClearedAt=0; lastWinner=null; lastWord=null;
  $word.textContent=$hint.textContent=$drawerName.textContent=$roundStatus.textContent=$timer.textContent="‚Äî";
  $timerHUD.textContent="--:--"; hideOverlay();
  ctx.clearRect(0,0,$c.width,$c.height); $players.innerHTML=""; $chat.innerHTML="";
});

/* ---------- START (local-first) ---------- */
async function startNow(){
  if(!roomId||!nick) return;
  if(gameStatus==="jogando") return;

  const w=pickWord(), h=makeHint(w);
  isDrawer=true; gameStatus="jogando"; lastWinner=null; lastWord=w;
  $drawerName.textContent=nick; $roundStatus.textContent="jogando";
  $word.textContent=w; $hint.textContent=h; hideOverlay();
  $clear.disabled=false; $endRound.disabled=true;

  if(countdownInt){clearInterval(countdownInt)}
  const localDeadline=Date.now()+120000;
  const t=()=>{const left=Math.max(0,localDeadline-Date.now()); const mm=String(Math.floor(left/60000)).padStart(2,"0"); const ss=String(Math.floor((left%60000)/1000)).padStart(2,"0"); $timer.textContent=`${mm}:${ss}`; $timerHUD.textContent=`${mm}:${ss}`}; t(); countdownInt=setInterval(t,300);

  ctx.clearRect(0,0,$c.width,$c.height);

  try{
    const roomRef=db.collection("salas").doc(roomId);
    const stateRef=roomRef.collection("sync").doc("state");
    await stateRef.set({clearedAt:firebase.firestore.FieldValue.serverTimestamp(),lastSeg:null},{merge:true});
    const snap=await roomRef.get();
    const newRound=(snap.exists && snap.data().round)?(snap.data().round+1):1;

    await roomRef.set({
      currentDrawer:nick,status:"jogando",word:w,hint:h,winner:null,
      round:newRound,startAt:firebase.firestore.FieldValue.serverTimestamp(),durationSec:120
    },{merge:true});

    currentRound=newRound;
    bindGuessesForRound(currentRound);
    $endRound.disabled=false;
  }catch(e){
    console.error(e);
    isDrawer=false; gameStatus="‚Äî"; currentRound=0;
    $drawerName.textContent="‚Äî"; $roundStatus.textContent="‚Äî"; $word.textContent="‚Äî"; $hint.textContent="‚Äî"; $timer.textContent="‚Äî"; $timerHUD.textContent="--:--";
    $clear.disabled=true; $endRound.disabled=true; if(countdownInt){clearInterval(countdownInt);countdownInt=null}
    alert("N√£o foi poss√≠vel iniciar o jogo. Verifique as regras do Firestore.");
  }
}
$startGame.addEventListener("click", startNow);

/* ---------- Terminar rodada ---------- */
$endRound.addEventListener("click", async ()=>{
  if(!isDrawer || gameStatus!=="jogando") return;
  await db.collection("salas").doc(roomId).set({status:"encerrada",winner:null},{merge:true});
});

/* ---------- Sala / Timer / Overlay ---------- */
function listenRoom(){
  if(unsubRoom)unsubRoom();
  const roomRef=db.collection("salas").doc(roomId);
  let lastStatus="‚Äî";

  unsubRoom=roomRef.onSnapshot(doc=>{
    const data=doc.data()||{};
    gameStatus=data.status||"‚Äî";
    const drawer=data.currentDrawer||"‚Äî";
    isDrawer=(drawer===nick);
    $drawerName.textContent=drawer; $roundStatus.textContent=gameStatus;

    // round -> (re)bind chat
    const r=data.round||0;
    if(r!==currentRound){ currentRound=r; bindGuessesForRound(currentRound); }

    lastWinner=data.winner||null;
    lastWord=data.word||lastWord;

    if(gameStatus==="jogando"){
      hideOverlay();
      $word.textContent=isDrawer?(data.word||"‚Äî"):"üîí (secreto)";
      $hint.textContent=data.hint||"‚Äî";
      $clear.disabled=isDrawer; $endRound.disabled=!isDrawer;

      if(countdownInt){clearInterval(countdownInt)}
      let startMs=Date.now(); if(data.startAt&&data.startAt.toMillis) startMs=data.startAt.toMillis();
      const durMs=1000*(data.durationSec||120); const deadline=startMs+durMs;
      const tick=async()=>{
        const left=Math.max(0,deadline-Date.now());
        const mm=String(Math.floor(left/60000)).padStart(2,"0");
        const ss=String(Math.floor((left%60000)/1000)).padStart(2,"0");
        $timer.textContent=`${mm}:${ss}`; $timerHUD.textContent=`${mm}:${ss}`;
        if(left<=0){
          clearInterval(countdownInt); countdownInt=null;
          if(isDrawer){ await db.collection("salas").doc(roomId).set({status:"encerrada",winner:null},{merge:true}); }
        }
      };
      tick(); countdownInt=setInterval(tick,300);
    } else {
      if(countdownInt){clearInterval(countdownInt);countdownInt=null}
      $timer.textContent="‚Äî"; $timerHUD.textContent="--:--";
      $word.textContent="‚Äî"; $hint.textContent="‚Äî";
      $clear.disabled=true; $endRound.disabled=true;

      // Exibe overlay ao encerrar
      if(lastStatus==="jogando"){
        if(lastWinner){
          showOverlay(`Parab√©ns, ${String(lastWinner).toUpperCase()} - ${String(lastWord||"").toUpperCase()}`);
        }else{
          showOverlay(`Tempo esgotado! A palavra era ${String(lastWord||"").toUpperCase()}`);
        }
      }
      if(lastStatus!=="jogando"){ hideOverlay(); }
    }
    lastStatus=gameStatus;
  });
}

/* ---------- Presen√ßa ---------- */
function listenPlayers(){
  if(unsubPlayers)unsubPlayers();
  const ref=db.collection("salas").doc(roomId).collection("players");
  unsubPlayers=ref.orderBy("joinedAt").onSnapshot(snap=>{
    const now=Date.now(); const active=[];
    snap.forEach(d=>{
      const p=d.data()||{}; const seen=p.lastSeen&&p.lastSeen.toMillis?p.lastSeen.toMillis():0;
      if((now-seen)<=15000 && p.online!==false) active.push(d.id);
    });
    active.sort((a,b)=>a.localeCompare(b));
    playersList=active;
    $players.innerHTML=playersList.length?playersList.map(n=>(n===nick?"üë§ ":"üë• ")+n).join("<br>"):"<em>Ningu√©m ativo</em>";
  });
}

/* ---------- Espelho do desenho (clear s√≥ quando mudar) ---------- */
function listenState(){
  if(unsubState)unsubState();
  const ref=db.collection("salas").doc(roomId).collection("sync").doc("state");
  unsubState=ref.onSnapshot(doc=>{
    const data=doc.data()||{};
    let cur=0; if(data.clearedAt&&data.clearedAt.toMillis) cur=data.clearedAt.toMillis();
    else if(typeof data.clearedAt==="number") cur=data.clearedAt;
    if(cur && cur!==lastClearedAt){ lastClearedAt=cur; ctx.clearRect(0,0,$c.width,$c.height); }
    const s=data.lastSeg; if(s && s.by!==nick) drawSeg(s.p0,s.p1,s.color||"#111",s.size||6);
  });
}

/* ---------- Desenho (Pointer Events + Hi-DPI) ---------- */
function cssPos(e){ const r=$c.getBoundingClientRect(); const X=e.clientX; const Y=e.clientY; return [Math.max(0,Math.min(1,(X-r.left)/r.width)), Math.max(0,Math.min(1,(Y-r.top)/r.height))]; }
function drawSeg(p0,p1,color,size){ ctx.lineCap="round"; ctx.lineJoin="round"; ctx.strokeStyle=color; ctx.lineWidth=size; ctx.beginPath(); ctx.moveTo(p0[0]*$c.width/dpr,p0[1]*$c.height/dpr); ctx.lineTo(p1[0]*$c.width/dpr,p1[1]*$c.height/dpr); ctx.stroke(); }
async function pushSeg(p0,p1,color,size){
  const ref=db.collection("salas").doc(roomId).collection("sync").doc("state");
  await ref.set({lastSeg:{by:nick,p0,p1,color,size:Number(size),ts:firebase.firestore.FieldValue.serverTimestamp()}},{merge:true});
}
let drawing=false,last=null; const canDraw=()=> isDrawer && gameStatus==="jogando";
$c.addEventListener("pointerdown",e=>{ if(!canDraw())return; drawing=true; $c.setPointerCapture(e.pointerId); last=cssPos(e); e.preventDefault(); });
$c.addEventListener("pointermove",async e=>{ if(!drawing||!canDraw())return; const p=cssPos(e); drawSeg(last,p,$color.value,Number($size.value)); try{await pushSeg(last,p,$color.value,Number($size.value))}catch{} last=p; e.preventDefault(); });
$c.addEventListener("pointerup",e=>{ drawing=false; try{$c.releasePointerCapture(e.pointerId);}catch{} });
$c.addEventListener("pointercancel",()=>{ drawing=false; });
$clear.addEventListener("click",async()=>{ if(!canDraw())return; ctx.clearRect(0,0,$c.width,$c.height); const ref=db.collection("salas").doc(roomId).collection("sync").doc("state"); await ref.set({clearedAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:true}); });
$c.addEventListener("contextmenu",e=>e.preventDefault());

/* ---------- Chat (ao lado do nome) ---------- */
function addMsg({nick,text,correct}){
  const row=document.createElement("div"); row.className="chat-row";
  const name=document.createElement("div"); name.className="chat-name"; name.textContent=nick;
  const msg=document.createElement("div"); msg.className="chat-text"; msg.textContent=text;
  if(correct) msg.classList.add("chat-correct");
  row.append(name,msg); $chat.appendChild(row); $chat.scrollTop=$chat.scrollHeight;
}
function bindGuessesForRound(round){
  if(unsubGuesses){unsubGuesses();unsubGuesses=null;}
  $chat.innerHTML="";
  unsubGuesses=db.collection("salas").doc(roomId).collection("guesses")
    .orderBy("ts","asc").limit(500)
    .onSnapshot(s=>{
      s.docChanges().forEach(ch=>{
        if(ch.type!=="added") return; const d=ch.doc.data()||{};
        if((d.round||0)!==round) return; addMsg(d);
      });
      $chat.removeAttribute("aria-busy");
    });
}
$chatForm.addEventListener("submit",async e=>{
  e.preventDefault(); if(!$chatInput.value.trim())return;
  const text=$chatInput.value.trim(); $chatInput.value="";
  const roomDoc=await db.collection("salas").doc(roomId).get(); const data=roomDoc.data()||{};
  const correct=(data.status==="jogando") && normalize(text)===normalize(data.word);
  const r=data.round||currentRound||0;
  await db.collection("salas").doc(roomId).collection("guesses").add({ nick,text,correct:!!correct,round:r,ts:firebase.firestore.FieldValue.serverTimestamp() });
  if(correct) await db.collection("salas").doc(roomId).set({status:"encerrada",winner:nick},{merge:true});
});
</script>
</body>
</html>
