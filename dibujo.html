<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Desenho sincronizado (Ultra Simples)</title>
<style>
  body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#f7f7f8;color:#111}
  header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:#fff;box-shadow:0 6px 18px rgba(0,0,0,.08);position:sticky;top:0}
  .pill{background:#111;color:#fff;border-radius:999px;padding:4px 10px;font-size:12px}
  main{max-width:900px;margin:20px auto;padding:0 16px;display:grid;gap:12px}
  .row{display:grid;grid-template-columns:1fr 1fr auto auto;gap:8px}
  input,button{font:inherit;padding:8px 10px;border-radius:10px;border:1px solid #ddd}
  button{background:#111;color:#fff;border:0;cursor:pointer}
  button:disabled{opacity:.5;cursor:not-allowed}
  #wrap{border:1px solid #eee;border-radius:12px;overflow:hidden;background:#fff}
  canvas{display:block;width:100%;height:480px;touch-action:none}
  .bar{display:flex;gap:12px;align-items:center}
</style>
</head>
<body>
<header>
  <div><strong>Desenho sincronizado</strong> — versão de teste mínima</div>
  <div class="pill" id="status">desconectado</div>
</header>
<main>
  <div class="row">
    <input id="nick" placeholder="apelido (ex.: Alex)">
    <input id="room" placeholder="sala (ex.: geral)" value="geral">
    <button id="connect">Conectar</button>
    <button id="clear" disabled>Limpar</button>
  </div>
  <div class="bar">
    <label>Cor <input type="color" id="color" value="#111111"></label>
    <label>Espessura <input type="range" id="size" min="2" max="18" value="6"></label>
    <div id="who" class="pill" style="background:#444">você: —</div>
  </div>
  <div id="wrap"><canvas id="c"></canvas></div>
  <div>Abra em duas abas/dispositivos, entre na <strong>mesma sala</strong>. Qualquer pessoa que desenhar será vista pela outra ao vivo.</div>
</main>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script>
// COLOQUEI seu config:
const firebaseConfig = {
  apiKey: "AIzaSyA9FBaZDDJ_fOOWW4JNxoR_IbHCTG9CgqE",
  authDomain: "chatenvivo-6b518.firebaseapp.com",
  projectId: "chatenvivo-6b518",
  storageBucket: "chatenvivo-6b518.firebasestorage.app",
  messagingSenderId: "351680385901",
  appId: "1:351680385901:web:8105134053b010cd69c064",
  measurementId: "G-HF86GVYTVC"
};
let app, db;
try { app = firebase.initializeApp(firebaseConfig); db = firebase.firestore(); document.getElementById("status").textContent = "SDK carregado"; } catch(e){ console.error(e); }

const $c = document.getElementById("c"), ctx = $c.getContext("2d");
const $status = document.getElementById("status");
const $nick = document.getElementById("nick");
const $room = document.getElementById("room");
const $connect = document.getElementById("connect");
const $clear = document.getElementById("clear");
const $color = document.getElementById("color");
const $size = document.getElementById("size");
const $who = document.getElementById("who");

function resize(){ const r=$c.getBoundingClientRect(); $c.width=r.width|0; $c.height=r.height|0; }
window.addEventListener("resize", resize); setTimeout(resize,0);

let nick="", roomId="", unsub=null;
function pos(evt){ const r=$c.getBoundingClientRect(); const X=evt.touches?evt.touches[0].clientX:evt.clientX; const Y=evt.touches?evt.touches[0].clientY:evt.clientY; return [Math.max(0,Math.min(1,(X-r.left)/r.width)), Math.max(0,Math.min(1,(Y-r.top)/r.height))];}
function drawSeg(p0,p1,color,size){ ctx.lineCap="round"; ctx.lineJoin="round"; ctx.strokeStyle=color; ctx.lineWidth=size; ctx.beginPath(); ctx.moveTo(p0[0]*$c.width,p0[1]*$c.height); ctx.lineTo(p1[0]*$c.width,p1[1]*$c.height); ctx.stroke(); }

$connect.addEventListener("click", async ()=>{
  nick = ($nick.value||"Anon").trim();
  roomId = ($room.value||"geral").trim().toLowerCase();
  if (!db) return alert("Firebase não configurado.");
  $status.textContent = "conectado"; $clear.disabled=true;
  $who.textContent = "você: " + nick;
  // listener do último segmento
  const ref = db.collection("salas").doc(roomId).collection("sync").doc("state");
  unsub && unsub();
  unsub = ref.onSnapshot((doc)=>{
    const data = doc.data()||{};
    if (data.lastSeg){
      const s = data.lastSeg;
      if (s.by !== nick) { // não redesenhar o próprio
        drawSeg(s.p0, s.p1, s.color||"#111", s.size||6);
      }
    }
    if (data.clearedAt) { ctx.clearRect(0,0,$c.width,$c.height); }
  });
  // ensure doc exists
  await ref.set({createdAt: firebase.firestore.FieldValue.serverTimestamp()}, {merge:true});
  $clear.disabled=false;
});

let drawing=false, last=null;
async function sendSeg(p0,p1){
  const ref = db.collection("salas").doc(roomId).collection("sync").doc("state");
  await ref.update({ lastSeg: { by:nick, p0, p1, color:$color.value, size:Number($size.value), ts: firebase.firestore.FieldValue.serverTimestamp() } });
}

$c.addEventListener("mousedown", (e)=>{ drawing=true; last=pos(e); e.preventDefault(); });
$c.addEventListener("mousemove", async (e)=>{
  if(!drawing) return;
  const p = pos(e);
  drawSeg(last,p,$color.value,Number($size.value)); // local
  try { await sendSeg(last,p); } catch(err){ console.error(err); }
  last = p; e.preventDefault();
});
window.addEventListener("mouseup", ()=>{ drawing=false; });
$c.addEventListener("touchstart", (e)=>{ drawing=true; last=pos(e); e.preventDefault(); }, {passive:false});
$c.addEventListener("touchmove", async (e)=>{
  if(!drawing) return;
  const p = pos(e);
  drawSeg(last,p,$color.value,Number($size.value));
  try { await sendSeg(last,p); } catch(err){ console.error(err); }
  last = p; e.preventDefault();
}, {passive:false});
$c.addEventListener("touchend", ()=>{ drawing=false; });

$clear.addEventListener("click", async ()=>{
  ctx.clearRect(0,0,$c.width,$c.height);
  const ref = db.collection("salas").doc(roomId).collection("sync").doc("state");
  await ref.update({ clearedAt: firebase.firestore.FieldValue.serverTimestamp() });
});

$c.addEventListener("contextmenu", e=>e.preventDefault());
</script>
</body>
</html>
